{"version":3,"file":"lambda.js","names":["cdnDatastore","PATH_PREFIX","setupFsWrapper","fs","accessSync","__filename","constants","W_OK","path","join","__dirname","e","TEMP_DIR","tmpdir","TEMP_CACHE_DIR","global","__GATSBY","root","cacheDir","rewrites","console","log","from","to","lfs","link","key","Object","hasOwnProperty","call","native","dbPath","promises","_fsWrapper","dir","process","env","NETLIFY_LOCAL","existsSync","copySync","cwd","buildId","imageCDNUrlGeneratorModulePath","require","resolve","fileCDNUrlGeneratorModulePath","GraphQLEngine","getData","renderPageData","renderHTML","streamPipeline","promisify","pipeline","get","url","callback","URL","protocol","httpsGet","httpGet","getEngine","downloadPath","ensureDir","Promise","reject","req","response","statusCode","Error","statusMessage","fileStream","createWriteStream","then","catch","error","on","graphqlEngine","ready","engineReadyPromise","reverseFixedPagePath","pageDataRequestPath","getPathInfo","requestPath","matches","matchAll","requestedPagePath","isPageData","pagePath","setStatusAndHeaders","page","data","res","mode","serverDataStatus","status","serverDataHeaders","name","value","entries","setHeader","getErrorBody","body","filename","readFileSync","getPage","pathname","pathInfo","undefined","findPageByPath","engineHandler","pageInfo","originalPathName","startsWith","maybePath","slice","length","send","pathName","results","json"],"sources":["../../../src/utils/page-ssr-module/lambda.ts"],"sourcesContent":["import type { GatsbyFunctionResponse, GatsbyFunctionRequest } from \"gatsby\"\nimport * as path from \"path\"\nimport * as fs from \"fs-extra\"\nimport { get as httpsGet } from \"https\"\nimport { get as httpGet, IncomingMessage, ClientRequest } from \"http\"\nimport { tmpdir } from \"os\"\nimport { pipeline } from \"stream\"\nimport { URL } from \"url\"\nimport { promisify } from \"util\"\n\nimport type { IGatsbyPage } from \"../../internal\"\nimport type { ISSRData } from \"./entry\"\nimport { link } from \"linkfs\"\n\nconst cdnDatastore = `%CDN_DATASTORE_PATH%`\nconst PATH_PREFIX = `%PATH_PREFIX%`\n\nfunction setupFsWrapper(): string {\n  // setup global._fsWrapper\n  try {\n    fs.accessSync(__filename, fs.constants.W_OK)\n    // TODO: this seems funky - not sure if this is correct way to handle this, so just marking TODO to revisit this\n    return path.join(__dirname, `..`, `data`, `datastore`)\n  } catch (e) {\n    // we are in a read-only filesystem, so we need to use a temp dir\n\n    const TEMP_DIR = path.join(tmpdir(), `gatsby`)\n    const TEMP_CACHE_DIR = path.join(TEMP_DIR, `.cache`)\n\n    global.__GATSBY.root = TEMP_DIR\n\n    // TODO: don't hardcode this\n    const cacheDir = `/var/task/.cache`\n\n    // we need to rewrite fs\n    const rewrites = [\n      [path.join(cacheDir, `caches`), path.join(TEMP_CACHE_DIR, `caches`)],\n      [\n        path.join(cacheDir, `caches-lmdb`),\n        path.join(TEMP_CACHE_DIR, `caches-lmdb`),\n      ],\n      [path.join(cacheDir, `data`), path.join(TEMP_CACHE_DIR, `data`)],\n    ]\n\n    console.log(`Preparing Gatsby filesystem`, {\n      from: cacheDir,\n      to: TEMP_CACHE_DIR,\n      rewrites,\n    })\n    // Alias the cache dir paths to the temp dir\n    const lfs = link(fs, rewrites) as typeof import(\"fs\")\n\n    // linkfs doesn't pass across the `native` prop, which graceful-fs needs\n    for (const key in lfs) {\n      if (Object.hasOwnProperty.call(fs[key], `native`)) {\n        lfs[key].native = fs[key].native\n      }\n    }\n\n    const dbPath = path.join(TEMP_CACHE_DIR, `data`, `datastore`)\n\n    // 'promises' is not initially linked within the 'linkfs'\n    // package, and is needed by underlying Gatsby code (the\n    // @graphql-tools/code-file-loader)\n    lfs.promises = link(fs.promises, rewrites)\n\n    // Gatsby uses this instead of fs if present\n    // eslint-disable-next-line no-underscore-dangle\n    global._fsWrapper = lfs\n\n    if (!cdnDatastore) {\n      const dir = `data`\n      if (\n        !process.env.NETLIFY_LOCAL &&\n        fs.existsSync(path.join(TEMP_CACHE_DIR, dir))\n      ) {\n        console.log(`directory already exists`)\n        return dbPath\n      }\n      console.log(`Start copying ${dir}`)\n\n      fs.copySync(path.join(cacheDir, dir), path.join(TEMP_CACHE_DIR, dir))\n      console.log(`End copying ${dir}`)\n    }\n\n    return dbPath\n  }\n}\n\nglobal.__GATSBY = {\n  root: process.cwd(),\n  buildId: ``,\n}\n\n// eslint-disable-next-line no-constant-condition\nif (`%IMAGE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`) {\n  global.__GATSBY.imageCDNUrlGeneratorModulePath = require.resolve(\n    `%IMAGE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`\n  )\n}\n// eslint-disable-next-line no-constant-condition\nif (`%FILE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`) {\n  global.__GATSBY.fileCDNUrlGeneratorModulePath = require.resolve(\n    `%FILE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`\n  )\n}\n\nconst dbPath = setupFsWrapper()\n\n// using require instead of import here for now because of type hell + import path doesn't exist in current context\n// as this file will be copied elsewhere\n\ntype GraphQLEngineType =\n  import(\"../../schema/graphql-engine/entry\").GraphQLEngine\n\nconst { GraphQLEngine } =\n  require(`../query-engine`) as typeof import(\"../../schema/graphql-engine/entry\")\n\nconst { getData, renderPageData, renderHTML } =\n  require(`./index`) as typeof import(\"./entry\")\n\nconst streamPipeline = promisify(pipeline)\n\nfunction get(\n  url: string,\n  callback?: (res: IncomingMessage) => void\n): ClientRequest {\n  return new URL(url).protocol === `https:`\n    ? httpsGet(url, callback)\n    : httpGet(url, callback)\n}\n\nasync function getEngine(): Promise<GraphQLEngineType> {\n  if (cdnDatastore) {\n    // if this variable is set we need to download the datastore from the CDN\n    const downloadPath = dbPath + `/data.mdb`\n    console.log(\n      `Downloading datastore from CDN (${cdnDatastore} -> ${downloadPath})`\n    )\n\n    await fs.ensureDir(dbPath)\n    await new Promise((resolve, reject) => {\n      const req = get(cdnDatastore, response => {\n        if (\n          !response.statusCode ||\n          response.statusCode < 200 ||\n          response.statusCode > 299\n        ) {\n          reject(\n            new Error(\n              `Failed to download ${cdnDatastore}: ${response.statusCode} ${\n                response.statusMessage || ``\n              }`\n            )\n          )\n          return\n        }\n\n        const fileStream = fs.createWriteStream(downloadPath)\n        streamPipeline(response, fileStream)\n          .then(resolve)\n          .catch(error => {\n            console.log(`Error downloading ${cdnDatastore}`, error)\n            reject(error)\n          })\n      })\n\n      req.on(`error`, error => {\n        console.log(`Error downloading ${cdnDatastore}`, error)\n        reject(error)\n      })\n    })\n    console.log(`Downloaded datastore from CDN`)\n  }\n\n  const graphqlEngine = new GraphQLEngine({\n    dbPath,\n  })\n\n  await graphqlEngine.ready\n\n  return graphqlEngine\n}\n\nconst engineReadyPromise = getEngine()\n\nfunction reverseFixedPagePath(pageDataRequestPath: string): string {\n  return pageDataRequestPath === `index` ? `/` : pageDataRequestPath\n}\n\nfunction getPathInfo(requestPath: string):\n  | {\n      isPageData: boolean\n      pagePath: string\n    }\n  | undefined {\n  const matches = requestPath.matchAll(/^\\/?page-data\\/(.+)\\/page-data.json$/gm)\n  for (const [, requestedPagePath] of matches) {\n    return {\n      isPageData: true,\n      pagePath: reverseFixedPagePath(requestedPagePath),\n    }\n  }\n\n  // if not matched\n  return {\n    isPageData: false,\n    pagePath: requestPath,\n  }\n}\n\nfunction setStatusAndHeaders({\n  page,\n  data,\n  res,\n}: {\n  page: IGatsbyPage\n  data: ISSRData\n  res: GatsbyFunctionResponse\n}): void {\n  if (page.mode === `SSR`) {\n    if (data.serverDataStatus) {\n      res.status(data.serverDataStatus)\n    }\n  }\n  if (data.serverDataHeaders) {\n    for (const [name, value] of Object.entries(data.serverDataHeaders)) {\n      res.setHeader(name, value)\n    }\n  }\n}\n\nfunction getErrorBody(statusCode: number): string {\n  let body = `<html><body><h1>${statusCode}</h1><p>${\n    statusCode === 404 ? `Not found` : `Internal Server Error`\n  }</p></body></html>`\n\n  if (statusCode === 404 || statusCode === 500) {\n    const filename = path.join(process.cwd(), `public`, `${statusCode}.html`)\n\n    if (fs.existsSync(filename)) {\n      body = fs.readFileSync(filename, `utf8`)\n    }\n  }\n\n  return body\n}\n\ninterface IPageInfo {\n  page: IGatsbyPage\n  isPageData: boolean\n  pagePath: string\n}\n\nfunction getPage(\n  pathname: string,\n  graphqlEngine: GraphQLEngineType\n): IPageInfo | undefined {\n  const pathInfo = getPathInfo(pathname)\n  if (!pathInfo) {\n    return undefined\n  }\n\n  const { isPageData, pagePath } = pathInfo\n\n  const page = graphqlEngine.findPageByPath(pagePath)\n  if (!page) {\n    return undefined\n  }\n\n  return {\n    page,\n    isPageData,\n    pagePath,\n  }\n}\n\nasync function engineHandler(\n  req: GatsbyFunctionRequest,\n  res: GatsbyFunctionResponse\n): Promise<void> {\n  try {\n    const graphqlEngine = await engineReadyPromise\n    let pageInfo: IPageInfo | undefined\n\n    const originalPathName = req.url ?? ``\n\n    if (PATH_PREFIX && originalPathName.startsWith(PATH_PREFIX)) {\n      const maybePath = originalPathName.slice(PATH_PREFIX.length)\n      pageInfo = getPage(maybePath, graphqlEngine)\n    }\n\n    if (!pageInfo) {\n      pageInfo = getPage(originalPathName, graphqlEngine)\n    }\n\n    if (!pageInfo) {\n      res.status(404).send(getErrorBody(404))\n      return\n    }\n\n    const { pagePath, isPageData, page } = pageInfo\n\n    const data = await getData({\n      pathName: pagePath,\n      graphqlEngine,\n      req,\n    })\n\n    if (isPageData) {\n      const results = await renderPageData({ data })\n      setStatusAndHeaders({ page, data, res })\n      res.json(results)\n      return\n    } else {\n      const results = await renderHTML({ data })\n      setStatusAndHeaders({ page, data, res })\n      res.send(results)\n      return\n    }\n  } catch (e) {\n    console.error(`Engine failed to handle request`, e)\n    res.status(500).send(getErrorBody(500))\n  }\n}\n\nexport default engineHandler\n"],"mappings":"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"}